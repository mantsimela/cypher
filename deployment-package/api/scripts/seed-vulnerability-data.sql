-- =====================================================
-- Vulnerability Data Seeding Script
-- Populates vulnerabilities, vulnerability_cves, asset_vulnerabilities, and patches tables
-- =====================================================

-- Clear existing data (optional - uncomment if needed)
-- DELETE FROM vulnerability_cves;
-- DELETE FROM asset_vulnerabilities;
-- DELETE FROM vulnerabilities;

-- =====================================================
-- 1. VULNERABILITIES TABLE - 1000+ diverse vulnerabilities
-- =====================================================

-- Insert vulnerabilities with diverse plugin IDs, families, and severities
INSERT INTO vulnerabilities (asset_uuid, plugin_id, plugin_name, plugin_family, severity, severity_name, cvss_base_score, cvss3_base_score, description, solution, risk_factor, first_found, last_found, state, source, batch_id, raw_json) VALUES

-- Critical Vulnerabilities (Severity 4)
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 19506, 'Microsoft Windows SMB Remote Code Execution Vulnerability', 'Windows', 4, 'Critical', 9.3, 9.8, 'A remote code execution vulnerability exists in Microsoft Server Message Block 1.0 (SMBv1) server when handling certain requests. An attacker who successfully exploited this vulnerability could execute arbitrary code on the target system.', 'Apply the security update provided by Microsoft. Disable SMBv1 if not required.', 'Critical', NOW() - INTERVAL '30 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "SMBv1 enabled", "port": "445/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 51192, 'Apache HTTP Server Multiple Vulnerabilities', 'Web Servers', 4, 'Critical', 9.0, 9.1, 'Multiple vulnerabilities exist in Apache HTTP Server that could allow remote code execution, information disclosure, and denial of service attacks.', 'Upgrade to Apache HTTP Server 2.4.54 or later.', 'Critical', NOW() - INTERVAL '45 days', NOW() - INTERVAL '2 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Apache/2.4.41", "port": "80/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 162092, 'OpenSSL Multiple Vulnerabilities (Heartbleed)', 'General', 4, 'Critical', 7.5, 9.8, 'OpenSSL contains a vulnerability in the TLS/DTLS heartbeat extension that allows remote attackers to read sensitive information from process memory.', 'Upgrade to OpenSSL 1.0.1g or later. Regenerate SSL certificates and private keys.', 'Critical', NOW() - INTERVAL '60 days', NOW() - INTERVAL '3 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "OpenSSL 1.0.1f", "port": "443/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 78479, 'Microsoft Windows Kernel Privilege Escalation', 'Windows', 4, 'Critical', 8.8, 8.8, 'A privilege escalation vulnerability exists in the Windows kernel that allows local attackers to gain SYSTEM privileges.', 'Install the latest Windows security updates.', 'Critical', NOW() - INTERVAL '25 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Windows 10 Build 19041", "port": "0"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 156765, 'Log4j Remote Code Execution (Log4Shell)', 'Misc.', 4, 'Critical', 9.3, 10.0, 'Apache Log4j2 contains a remote code execution vulnerability that allows attackers to execute arbitrary code by controlling log message or message parameters.', 'Upgrade to Log4j 2.17.1 or later. Implement mitigations if immediate patching is not possible.', 'Critical', NOW() - INTERVAL '90 days', NOW() - INTERVAL '5 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "log4j-core-2.14.1.jar", "port": "8080/tcp"}'::jsonb),

-- High Vulnerabilities (Severity 3)
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 45590, 'MySQL Multiple Vulnerabilities', 'Databases', 3, 'High', 7.5, 7.8, 'Multiple vulnerabilities in MySQL Server could allow authenticated attackers to cause denial of service or gain unauthorized access to data.', 'Upgrade to MySQL 8.0.32 or later.', 'High', NOW() - INTERVAL '20 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "MySQL 5.7.35", "port": "3306/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 134472, 'Adobe Flash Player Multiple Vulnerabilities', 'Windows', 3, 'High', 8.8, 8.8, 'Multiple vulnerabilities in Adobe Flash Player could allow remote code execution when a user visits a malicious website.', 'Uninstall Adobe Flash Player or upgrade to the latest version.', 'High', NOW() - INTERVAL '35 days', NOW() - INTERVAL '2 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Flash Player 32.0.0.371", "port": "0"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 97833, 'PHP Multiple Vulnerabilities', 'CGI abuses', 3, 'High', 7.3, 7.5, 'Multiple vulnerabilities in PHP could allow remote attackers to execute arbitrary code or cause denial of service.', 'Upgrade to PHP 8.1.15 or later.', 'High', NOW() - INTERVAL '40 days', NOW() - INTERVAL '3 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "PHP/7.4.28", "port": "80/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 122689, 'VMware vCenter Server Multiple Vulnerabilities', 'Misc.', 3, 'High', 8.1, 8.2, 'Multiple vulnerabilities in VMware vCenter Server could allow remote code execution and privilege escalation.', 'Upgrade to vCenter Server 7.0 Update 3f or later.', 'High', NOW() - INTERVAL '15 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "vCenter 7.0.2", "port": "443/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 158476, 'Citrix NetScaler ADC and Gateway Vulnerabilities', 'Misc.', 3, 'High', 8.8, 9.8, 'Multiple vulnerabilities in Citrix NetScaler ADC and Gateway could allow unauthenticated remote code execution.', 'Apply the security updates provided by Citrix.', 'High', NOW() - INTERVAL '50 days', NOW() - INTERVAL '4 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "NetScaler 13.0", "port": "443/tcp"}'::jsonb);

-- Continue with more vulnerabilities using a different approach for bulk insertion
-- Generate Medium Vulnerabilities (Severity 2)
DO $$
DECLARE
    i INTEGER;
    asset_id UUID;
    plugin_ids INTEGER[] := ARRAY[10394, 10395, 11219, 11936, 12634, 15901, 18405, 19506, 20007, 21564, 22194, 25221, 26925, 31705, 33851, 35362, 35553, 42873, 45590, 51192, 52582, 56468, 57608, 58651, 62565, 65821, 69551, 72686, 78479, 81606, 84502, 90317, 97833, 104743, 110723, 122689, 134472, 142081, 156765, 158476];
    plugin_names TEXT[] := ARRAY[
        'SSL Certificate Cannot Be Trusted',
        'SSL Certificate Chain Contains RSA Keys Less Than 2048 bits',
        'Nessus SYN scanner',
        'OS Identification',
        'netstat portscanner (SSH)',
        'SSH Weak MAC Algorithms Enabled',
        'Microsoft Windows SMB Service Detection',
        'Microsoft Windows SMB Remote Code Execution Vulnerability',
        'SMB Signing not required',
        'SSH Weak Encryption Algorithms Enabled',
        'Nessus SNMP Scanner',
        'SSH Protocol Version 1 Session Key Retrieval',
        'DNS Server Cache Snooping Remote Information Disclosure',
        'SSL Anonymous Cipher Suites Supported',
        'SSL Certificate Signed Using Weak Hashing Algorithm',
        'SSL RC4 Cipher Suites Supported (Bar Mitzvah)',
        'SSL Medium Strength Cipher Suites Supported (SWEET32)',
        'SSL Weak Cipher Suites Supported',
        'MySQL Multiple Vulnerabilities',
        'Apache HTTP Server Multiple Vulnerabilities',
        'SSL Certificate with Wrong Hostname',
        'TLS Version 1.0 Protocol Detection',
        'SSL Weak Cipher Suites Supported (SWEET32)',
        'TLS Version 1.1 Protocol Detection',
        'SSL Certificate Expiry',
        'HTTP TRACE / TRACK Methods Allowed',
        'Apache HTTP Server ETag Header Information Disclosure Weakness',
        'Web Application Potentially Vulnerable to Clickjacking',
        'Microsoft Windows Kernel Privilege Escalation',
        'Web Server Uses Basic Authentication Without HTTPS',
        'HyperText Transfer Protocol (HTTP) Information',
        'TCP/IP Timestamps Supported',
        'PHP Multiple Vulnerabilities',
        'Web Server Directory Traversal',
        'Missing HttpOnly Cookie Attribute',
        'VMware vCenter Server Multiple Vulnerabilities',
        'Adobe Flash Player Multiple Vulnerabilities',
        'Weak Password Policy',
        'Log4j Remote Code Execution (Log4Shell)',
        'Citrix NetScaler ADC and Gateway Vulnerabilities'
    ];
    families TEXT[] := ARRAY['Windows', 'General', 'Port scanners', 'General', 'General', 'Misc.', 'Windows', 'Windows', 'Windows', 'Misc.', 'SNMP', 'Misc.', 'DNS', 'General', 'General', 'General', 'General', 'General', 'Databases', 'Web Servers', 'General', 'General', 'General', 'General', 'General', 'Web Servers', 'Web Servers', 'Web Servers', 'Windows', 'Web Servers', 'Web Servers', 'General', 'CGI abuses', 'Web Servers', 'Web Servers', 'Misc.', 'Windows', 'Policy Compliance', 'Misc.', 'Misc.'];
BEGIN
    FOR i IN 1..1000 LOOP
        -- Get random asset
        SELECT asset_uuid INTO asset_id FROM assets ORDER BY RANDOM() LIMIT 1;
        
        -- Insert vulnerability with random data
        INSERT INTO vulnerabilities (
            asset_uuid, plugin_id, plugin_name, plugin_family, severity, severity_name, 
            cvss_base_score, cvss3_base_score, description, solution, risk_factor, 
            first_found, last_found, state, source, batch_id, raw_json
        ) VALUES (
            asset_id,
            plugin_ids[1 + (i % array_length(plugin_ids, 1))],
            plugin_names[1 + (i % array_length(plugin_names, 1))],
            families[1 + (i % array_length(families, 1))],
            CASE 
                WHEN i % 10 = 0 THEN 4  -- 10% Critical
                WHEN i % 4 = 0 THEN 3   -- 25% High  
                WHEN i % 2 = 0 THEN 2   -- 50% Medium
                ELSE 1                  -- 25% Low
            END,
            CASE 
                WHEN i % 10 = 0 THEN 'Critical'
                WHEN i % 4 = 0 THEN 'High'
                WHEN i % 2 = 0 THEN 'Medium'
                ELSE 'Low'
            END,
            ROUND((RANDOM() * 9 + 1)::numeric, 1),  -- CVSS 1.0-10.0
            ROUND((RANDOM() * 9 + 1)::numeric, 1),  -- CVSS3 1.0-10.0
            'Vulnerability description for plugin ' || (plugin_ids[1 + (i % array_length(plugin_ids, 1))])::text,
            'Apply security patches and follow vendor recommendations.',
            CASE 
                WHEN i % 10 = 0 THEN 'Critical'
                WHEN i % 4 = 0 THEN 'High'
                WHEN i % 2 = 0 THEN 'Medium'
                ELSE 'Low'
            END,
            NOW() - (RANDOM() * 90 || ' days')::interval,  -- Random first_found within 90 days
            NOW() - (RANDOM() * 30 || ' days')::interval,  -- Random last_found within 30 days
            CASE WHEN RANDOM() > 0.3 THEN 'Open' ELSE 'Fixed' END,
            'tenable',
            gen_random_uuid(),
            ('{"plugin_output": "Generated vulnerability ' || i || '", "port": "' || (80 + (RANDOM() * 8000)::integer) || '/tcp"}')::jsonb
        );
    END LOOP;
END $$;

-- =====================================================
-- 2. VULNERABILITY_CVES TABLE - Associate CVEs with vulnerabilities
-- =====================================================

-- First, ensure we have some CVEs in the cves table
INSERT INTO cves (cve_id, description, published_date, last_modified_date, cvss2_base_score, cvss2_vector, cvss3_base_score, cvss3_vector) VALUES
('CVE-2017-0144', 'The SMBv1 server in Microsoft Windows allows remote attackers to execute arbitrary code via crafted packets', '2017-03-14', '2017-05-12', 9.3, 'AV:N/AC:M/Au:N/C:C/I:C/A:C', 9.3, 'CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H'),
('CVE-2021-44228', 'Apache Log4j2 JNDI features do not protect against attacker controlled LDAP endpoints', '2021-12-09', '2021-12-10', 10.0, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 10.0, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H'),
('CVE-2014-0160', 'OpenSSL Heartbeat Extension allows remote attackers to obtain sensitive information from process memory', '2014-04-07', '2017-11-04', 7.5, 'AV:N/AC:L/Au:N/C:P/I:N/A:N', 7.5, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N'),
('CVE-2021-34527', 'Windows Print Spooler Remote Code Execution Vulnerability', '2021-07-01', '2021-07-13', 8.8, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 8.8, 'CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H'),
('CVE-2022-22965', 'Spring MVC or WebFlux application may be vulnerable to remote code execution via data binding', '2022-03-31', '2022-04-01', 9.8, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 9.8, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H');

-- Associate vulnerabilities with CVEs (some vulnerabilities have multiple CVEs)
DO $$
DECLARE
    vuln_record RECORD;
    cve_list TEXT[] := ARRAY['CVE-2017-0144', 'CVE-2021-44228', 'CVE-2014-0160', 'CVE-2021-34527', 'CVE-2022-22965'];
    num_cves INTEGER;
    i INTEGER;
BEGIN
    -- For each vulnerability, randomly assign 1-3 CVEs
    FOR vuln_record IN SELECT id FROM vulnerabilities ORDER BY id LOOP
        num_cves := 1 + (RANDOM() * 2)::integer; -- 1 to 3 CVEs per vulnerability

        FOR i IN 1..num_cves LOOP
            INSERT INTO vulnerability_cves (vulnerability_id, cve_id)
            VALUES (
                vuln_record.id,
                cve_list[1 + (RANDOM() * array_length(cve_list, 1))::integer]
            )
            -- Skip if already exists (no unique constraint defined)
        END LOOP;
    END LOOP;
END $$;

-- =====================================================
-- 3. ASSET_VULNERABILITIES TABLE - Associate assets with vulnerabilities
-- =====================================================

-- Create asset-vulnerability relationships (some assets have multiple vulnerabilities)
DO $$
DECLARE
    asset_record RECORD;
    vuln_record RECORD;
    num_vulns INTEGER;
    i INTEGER;
BEGIN
    -- For each asset, assign random number of vulnerabilities
    FOR asset_record IN SELECT id FROM assets ORDER BY id LOOP
        num_vulns := 1 + (RANDOM() * 15)::integer; -- 1 to 15 vulnerabilities per asset

        FOR i IN 1..num_vulns LOOP
            -- Get random vulnerability
            SELECT id INTO vuln_record FROM vulnerabilities ORDER BY RANDOM() LIMIT 1;

            INSERT INTO asset_vulnerabilities (
                asset_id,
                vulnerability_id,
                detection_status,
                first_detected,
                last_detected,
                notes
            )
            VALUES (
                asset_record.id,
                vuln_record.id,
                CASE
                    WHEN RANDOM() > 0.7 THEN 'confirmed'
                    WHEN RANDOM() > 0.4 THEN 'potential'
                    ELSE 'false_positive'
                END,
                NOW() - (RANDOM() * 60 || ' days')::interval,
                NOW() - (RANDOM() * 30 || ' days')::interval,
                'Detected via automated scan'
            )
            -- Skip if already exists (no unique constraint defined)
        END LOOP;
    END LOOP;
END $$;

-- =====================================================
-- 4. PATCHES TABLE - Create patches for vulnerabilities that require them
-- =====================================================

-- First, create some patch records
INSERT INTO patches (patch_id, title, description, vendor, release_date, severity, patch_type, download_url, file_size, checksum) VALUES
('MS17-010', 'Security Update for Microsoft Windows SMB Server', 'This security update resolves vulnerabilities in Microsoft Windows. The most severe of the vulnerabilities could allow remote code execution if an attacker sends specially crafted messages to a Microsoft Server Message Block 1.0 (SMBv1) server.', 'Microsoft', '2017-03-14', 'Critical', 'Security Update', 'https://www.microsoft.com/en-us/download/details.aspx?id=55245', 45678901, 'a1b2c3d4e5f6789012345678901234567890abcd'),
('KB5022834', 'Windows Security Update January 2023', 'This update includes quality improvements and security fixes for Windows systems.', 'Microsoft', '2023-01-10', 'Important', 'Cumulative Update', 'https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB5022834', 123456789, 'b2c3d4e5f6789012345678901234567890abcde1'),
('APACHE-2.4.54', 'Apache HTTP Server 2.4.54', 'This release fixes several security vulnerabilities and includes performance improvements.', 'Apache Software Foundation', '2022-06-08', 'High', 'Version Update', 'https://httpd.apache.org/download.cgi', 9876543, 'c3d4e5f6789012345678901234567890abcdef12'),
('OPENSSL-1.0.1g', 'OpenSSL 1.0.1g Security Update', 'This version fixes the Heartbleed vulnerability (CVE-2014-0160) and other security issues.', 'OpenSSL Project', '2014-04-07', 'Critical', 'Security Update', 'https://www.openssl.org/source/', 5432109, 'd4e5f6789012345678901234567890abcdef123'),
('LOG4J-2.17.1', 'Apache Log4j 2.17.1', 'This release addresses the Log4Shell vulnerability (CVE-2021-44228) and related security issues.', 'Apache Software Foundation', '2021-12-27', 'Critical', 'Security Update', 'https://logging.apache.org/log4j/2.x/download.html', 2345678, 'e5f6789012345678901234567890abcdef1234'),
('MYSQL-8.0.32', 'MySQL Server 8.0.32', 'This release includes security fixes and performance improvements for MySQL Server.', 'Oracle Corporation', '2023-01-17', 'Medium', 'Version Update', 'https://dev.mysql.com/downloads/mysql/', 87654321, 'f6789012345678901234567890abcdef12345'),
('PHP-8.1.15', 'PHP 8.1.15 Security Release', 'This release fixes several security vulnerabilities in PHP.', 'PHP Group', '2023-02-14', 'High', 'Security Update', 'https://www.php.net/downloads.php', 15432109, '789012345678901234567890abcdef123456'),
('VMWARE-7.0U3f', 'VMware vCenter Server 7.0 Update 3f', 'This update addresses multiple security vulnerabilities in vCenter Server.', 'VMware', '2022-04-12', 'High', 'Security Update', 'https://customerconnect.vmware.com/', 234567890, '89012345678901234567890abcdef1234567'),
('CITRIX-13.0-82.45', 'Citrix NetScaler ADC and Gateway 13.0-82.45', 'This build addresses critical security vulnerabilities.', 'Citrix', '2023-01-17', 'Critical', 'Security Update', 'https://www.citrix.com/downloads/', 345678901, '9012345678901234567890abcdef12345678'),
('FLASH-32.0.0.465', 'Adobe Flash Player 32.0.0.465', 'Final security update for Adobe Flash Player before end-of-life.', 'Adobe', '2020-12-08', 'High', 'Security Update', 'https://www.adobe.com/products/flashplayer/end-of-life.html', 19876543, '012345678901234567890abcdef123456789');

-- Associate vulnerabilities with patches (only patch-related vulnerabilities)
DO $$
DECLARE
    vuln_record RECORD;
    patch_mappings RECORD;
    patch_list TEXT[] := ARRAY['MS17-010', 'KB5022834', 'APACHE-2.4.54', 'OPENSSL-1.0.1g', 'LOG4J-2.17.1', 'MYSQL-8.0.32', 'PHP-8.1.15', 'VMWARE-7.0U3f', 'CITRIX-13.0-82.45', 'FLASH-32.0.0.465'];
    effectiveness_list TEXT[] := ARRAY['complete', 'partial', 'minimal'];
BEGIN
    -- Create vulnerability-patch relationships for vulnerabilities that need patches
    -- Focus on Critical and High severity vulnerabilities
    FOR vuln_record IN
        SELECT id, plugin_name, severity
        FROM vulnerabilities
        WHERE severity >= 3  -- High and Critical only
        ORDER BY id
    LOOP
        -- Determine if this vulnerability needs a patch (70% chance for high/critical)
        IF RANDOM() > 0.3 THEN
            -- Get patch ID from patches table
            SELECT patch_id INTO patch_mappings
            FROM patches
            ORDER BY RANDOM()
            LIMIT 1;

            INSERT INTO vulnerability_patches (
                vulnerability_id,
                patch_id,
                effectiveness,
                notes
            )
            VALUES (
                vuln_record.id,
                (SELECT id FROM patches WHERE patch_id = patch_mappings.patch_id),
                effectiveness_list[1 + (RANDOM() * array_length(effectiveness_list, 1))::integer],
                CASE
                    WHEN vuln_record.severity = 4 THEN 'Critical patch required immediately'
                    WHEN vuln_record.severity = 3 THEN 'High priority patch recommended'
                    ELSE 'Standard patch deployment'
                END
            );
        END IF;
    END LOOP;

    -- Also create patches for some medium severity vulnerabilities (30% chance)
    FOR vuln_record IN
        SELECT id, plugin_name, severity
        FROM vulnerabilities
        WHERE severity = 2  -- Medium severity
        ORDER BY id
    LOOP
        IF RANDOM() > 0.7 THEN  -- 30% chance
            SELECT patch_id INTO patch_mappings
            FROM patches
            ORDER BY RANDOM()
            LIMIT 1;

            INSERT INTO vulnerability_patches (
                vulnerability_id,
                patch_id,
                effectiveness,
                notes
            )
            VALUES (
                vuln_record.id,
                (SELECT id FROM patches WHERE patch_id = patch_mappings.patch_id),
                effectiveness_list[1 + (RANDOM() * array_length(effectiveness_list, 1))::integer],
                'Medium priority patch - schedule during maintenance window'
            );
        END IF;
    END LOOP;
END $$;

-- =====================================================
-- SUMMARY QUERIES - Verify data insertion
-- =====================================================

-- Display summary of inserted data
SELECT
    'Vulnerabilities' as table_name,
    COUNT(*) as record_count,
    COUNT(CASE WHEN severity = 4 THEN 1 END) as critical_count,
    COUNT(CASE WHEN severity = 3 THEN 1 END) as high_count,
    COUNT(CASE WHEN severity = 2 THEN 1 END) as medium_count,
    COUNT(CASE WHEN severity = 1 THEN 1 END) as low_count
FROM vulnerabilities

UNION ALL

SELECT
    'Vulnerability CVEs' as table_name,
    COUNT(*) as record_count,
    NULL, NULL, NULL, NULL
FROM vulnerability_cves

UNION ALL

SELECT
    'Asset Vulnerabilities' as table_name,
    COUNT(*) as record_count,
    COUNT(CASE WHEN detection_status = 'detected' THEN 1 END) as detected_count,
    NULL as potential_count,
    NULL as false_positive_count,
    NULL
FROM asset_vulnerabilities

UNION ALL

SELECT
    'Vulnerability Patches' as table_name,
    COUNT(*) as record_count,
    COUNT(CASE WHEN effectiveness = 'complete' THEN 1 END) as complete_patches,
    COUNT(CASE WHEN effectiveness = 'partial' THEN 1 END) as partial_patches,
    COUNT(CASE WHEN effectiveness = 'minimal' THEN 1 END) as minimal_patches,
    NULL
FROM vulnerability_patches;

-- Show some sample data
SELECT 'Sample Vulnerabilities:' as info;
SELECT id, plugin_name, severity_name, cvss3_base_score, state
FROM vulnerabilities
ORDER BY severity DESC, cvss3_base_score DESC
LIMIT 10;

SELECT 'Sample Asset-Vulnerability Relationships:' as info;
SELECT av.asset_id, v.plugin_name, av.detection_status, av.notes
FROM asset_vulnerabilities av
JOIN vulnerabilities v ON av.vulnerability_id = v.id
LIMIT 10;

SELECT 'Sample Vulnerability-Patch Relationships:' as info;
SELECT v.plugin_name, p.title, vp.effectiveness
FROM vulnerability_patches vp
JOIN vulnerabilities v ON vp.vulnerability_id = v.id
JOIN patches p ON vp.patch_id = p.id
LIMIT 10;
