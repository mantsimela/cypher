-- =====================================================
-- Simplified Vulnerability Data Seeding Script
-- Populates vulnerabilities, vulnerability_cves, asset_vulnerabilities, and patches tables
-- =====================================================

-- =====================================================
-- 1. VULNERABILITIES TABLE - Sample vulnerabilities
-- =====================================================

INSERT INTO vulnerabilities (asset_uuid, plugin_id, plugin_name, plugin_family, severity, severity_name, cvss_base_score, cvss3_base_score, description, solution, risk_factor, first_found, last_found, state, source, batch_id, raw_json) VALUES

-- Critical Vulnerabilities
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 19506, 'Microsoft Windows SMB Remote Code Execution Vulnerability', 'Windows', 4, 'Critical', 9.3, 9.8, 'A remote code execution vulnerability exists in Microsoft Server Message Block 1.0 (SMBv1) server when handling certain requests.', 'Apply the security update provided by Microsoft. Disable SMBv1 if not required.', 'Critical', NOW() - INTERVAL '30 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "SMBv1 enabled", "port": "445/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 51192, 'Apache HTTP Server Multiple Vulnerabilities', 'Web Servers', 4, 'Critical', 9.0, 9.1, 'Multiple vulnerabilities exist in Apache HTTP Server that could allow remote code execution.', 'Upgrade to Apache HTTP Server 2.4.54 or later.', 'Critical', NOW() - INTERVAL '45 days', NOW() - INTERVAL '2 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Apache/2.4.41", "port": "80/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 162092, 'OpenSSL Multiple Vulnerabilities (Heartbleed)', 'General', 4, 'Critical', 7.5, 9.8, 'OpenSSL contains a vulnerability in the TLS/DTLS heartbeat extension.', 'Upgrade to OpenSSL 1.0.1g or later.', 'Critical', NOW() - INTERVAL '60 days', NOW() - INTERVAL '3 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "OpenSSL 1.0.1f", "port": "443/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 156765, 'Log4j Remote Code Execution (Log4Shell)', 'Misc.', 4, 'Critical', 9.3, 10.0, 'Apache Log4j2 contains a remote code execution vulnerability.', 'Upgrade to Log4j 2.17.1 or later.', 'Critical', NOW() - INTERVAL '90 days', NOW() - INTERVAL '5 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "log4j-core-2.14.1.jar", "port": "8080/tcp"}'::jsonb),

-- High Vulnerabilities
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 45590, 'MySQL Multiple Vulnerabilities', 'Databases', 3, 'High', 7.5, 7.8, 'Multiple vulnerabilities in MySQL Server could allow authenticated attackers to cause denial of service.', 'Upgrade to MySQL 8.0.32 or later.', 'High', NOW() - INTERVAL '20 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "MySQL 5.7.35", "port": "3306/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 97833, 'PHP Multiple Vulnerabilities', 'CGI abuses', 3, 'High', 7.3, 7.5, 'Multiple vulnerabilities in PHP could allow remote attackers to execute arbitrary code.', 'Upgrade to PHP 8.1.15 or later.', 'High', NOW() - INTERVAL '40 days', NOW() - INTERVAL '3 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "PHP/7.4.28", "port": "80/tcp"}'::jsonb),

-- Medium Vulnerabilities
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 10394, 'SSL Certificate Cannot Be Trusted', 'General', 2, 'Medium', 6.4, 6.5, 'The SSL certificate for this service cannot be trusted.', 'Replace the SSL certificate with a trusted certificate.', 'Medium', NOW() - INTERVAL '15 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Self-signed certificate", "port": "443/tcp"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 15901, 'SSH Weak MAC Algorithms Enabled', 'Misc.', 2, 'Medium', 5.3, 5.4, 'The remote SSH server is configured to allow weak MAC algorithms.', 'Configure the SSH server to disable weak MAC algorithms.', 'Medium', NOW() - INTERVAL '25 days', NOW() - INTERVAL '2 days', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "hmac-md5", "port": "22/tcp"}'::jsonb),

-- Low Vulnerabilities
((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 11219, 'Nessus SYN scanner', 'Port scanners', 1, 'Low', 0.0, 0.0, 'This plugin is a SYN port scanner.', 'No action required - informational only.', 'None', NOW() - INTERVAL '10 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Port scan results", "port": "0"}'::jsonb),

((SELECT asset_uuid FROM assets ORDER BY RANDOM() LIMIT 1), 11936, 'OS Identification', 'General', 1, 'Low', 0.0, 0.0, 'It was possible to identify the remote operating system.', 'No action required - informational only.', 'None', NOW() - INTERVAL '5 days', NOW() - INTERVAL '1 day', 'Open', 'tenable', gen_random_uuid(), '{"plugin_output": "Windows 10", "port": "0"}'::jsonb);

-- =====================================================
-- 2. CVE DATA
-- =====================================================

INSERT INTO cves (cve_id, description, published_date, last_modified_date, cvss2_base_score, cvss2_vector, cvss3_base_score, cvss3_vector) VALUES
('CVE-2017-0144', 'The SMBv1 server in Microsoft Windows allows remote attackers to execute arbitrary code via crafted packets', '2017-03-14', '2017-05-12', 9.3, 'AV:N/AC:M/Au:N/C:C/I:C/A:C', 9.3, 'CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H'),
('CVE-2021-44228', 'Apache Log4j2 JNDI features do not protect against attacker controlled LDAP endpoints', '2021-12-09', '2021-12-10', 10.0, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 10.0, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H'),
('CVE-2014-0160', 'OpenSSL Heartbeat Extension allows remote attackers to obtain sensitive information from process memory', '2014-04-07', '2017-11-04', 7.5, 'AV:N/AC:L/Au:N/C:P/I:N/A:N', 7.5, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N'),
('CVE-2021-34527', 'Windows Print Spooler Remote Code Execution Vulnerability', '2021-07-01', '2021-07-13', 8.8, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 8.8, 'CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H'),
('CVE-2022-22965', 'Spring MVC or WebFlux application may be vulnerable to remote code execution via data binding', '2022-03-31', '2022-04-01', 9.8, 'AV:N/AC:L/Au:N/C:C/I:C/A:C', 9.8, 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H');

-- =====================================================
-- 3. PATCHES DATA (Skip if already exists)
-- =====================================================

INSERT INTO patches (patch_id, title, description, vendor, release_date, severity, patch_type, download_url, file_size, checksum)
SELECT * FROM (VALUES
('MS17-010-NEW', 'Security Update for Microsoft Windows SMB Server', 'This security update resolves vulnerabilities in Microsoft Windows SMB.', 'Microsoft', '2017-03-14'::timestamp, 'Critical', 'Security Update', 'https://www.microsoft.com/en-us/download/details.aspx?id=55245', '45678901', 'a1b2c3d4e5f6789012345678901234567890abcd'),
('LOG4J-2.17.1-NEW', 'Apache Log4j 2.17.1', 'This release addresses the Log4Shell vulnerability.', 'Apache Software Foundation', '2021-12-27'::timestamp, 'Critical', 'Security Update', 'https://logging.apache.org/log4j/2.x/download.html', '2345678', 'e5f6789012345678901234567890abcdef1234'),
('OPENSSL-1.0.1g-NEW', 'OpenSSL 1.0.1g Security Update', 'This version fixes the Heartbleed vulnerability.', 'OpenSSL Project', '2014-04-07'::timestamp, 'Critical', 'Security Update', 'https://www.openssl.org/source/', '5432109', 'd4e5f6789012345678901234567890abcdef123'),
('APACHE-2.4.54-NEW', 'Apache HTTP Server 2.4.54', 'This release fixes several security vulnerabilities.', 'Apache Software Foundation', '2022-06-08'::timestamp, 'High', 'Version Update', 'https://httpd.apache.org/download.cgi', '9876543', 'c3d4e5f6789012345678901234567890abcdef12'),
('MYSQL-8.0.32-NEW', 'MySQL Server 8.0.32', 'This release includes security fixes for MySQL Server.', 'Oracle Corporation', '2023-01-17'::timestamp, 'Medium', 'Version Update', 'https://dev.mysql.com/downloads/mysql/', '87654321', 'f6789012345678901234567890abcdef12345')
) AS new_patches(patch_id, title, description, vendor, release_date, severity, patch_type, download_url, file_size, checksum)
WHERE NOT EXISTS (SELECT 1 FROM patches WHERE patches.patch_id = new_patches.patch_id);

-- =====================================================
-- SUMMARY
-- =====================================================

SELECT 'Vulnerability seeding completed!' as status;
SELECT COUNT(*) as vulnerability_count FROM vulnerabilities WHERE plugin_id IN (19506, 51192, 162092, 156765, 45590, 97833, 10394, 15901, 11219, 11936);
SELECT COUNT(*) as cve_count FROM cves WHERE cve_id IN ('CVE-2017-0144', 'CVE-2021-44228', 'CVE-2014-0160', 'CVE-2021-34527', 'CVE-2022-22965');
SELECT COUNT(*) as patch_count FROM patches WHERE patch_id LIKE '%-NEW';
