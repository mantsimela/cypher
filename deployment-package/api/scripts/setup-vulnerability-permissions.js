const { client } = require('../src/db');

async function setupVulnerabilityPermissions() {
  try {
    console.log('üîç Setting up vulnerability permissions...');
    
    // Check existing vulnerability permissions
    const existingPerms = await client`
      SELECT name, category, description 
      FROM permissions 
      WHERE name LIKE '%vulnerability%'
    `;
    
    console.log('üìã Existing vulnerability permissions:');
    console.table(existingPerms);
    
    // Define required vulnerability permissions
    const requiredPermissions = [
      {
        name: 'vulnerability_management:read',
        category: 'vulnerability_management',
        description: 'View vulnerability data and reports'
      },
      {
        name: 'vulnerability_management:write',
        category: 'vulnerability_management', 
        description: 'Create and update vulnerability records'
      },
      {
        name: 'vulnerability_management:delete',
        category: 'vulnerability_management',
        description: 'Delete vulnerability records'
      }
    ];
    
    // Insert missing permissions
    for (const perm of requiredPermissions) {
      const existing = await client`
        SELECT id FROM permissions WHERE name = ${perm.name}
      `;
      
      if (existing.length === 0) {
        await client`
          INSERT INTO permissions (name, category, description)
          VALUES (${perm.name}, ${perm.category}, ${perm.description})
        `;
        console.log(`‚úÖ Added permission: ${perm.name}`);
      } else {
        console.log(`‚ÑπÔ∏è  Permission already exists: ${perm.name}`);
      }
    }
    
    // Get admin role
    const adminRole = await client`
      SELECT id FROM roles WHERE name = 'admin'
    `;
    
    if (adminRole.length === 0) {
      console.log('‚ùå Admin role not found');
      return;
    }
    
    const adminRoleId = adminRole[0].id;
    console.log(`üëë Admin role ID: ${adminRoleId}`);
    
    // Assign vulnerability permissions to admin role
    for (const perm of requiredPermissions) {
      const permission = await client`
        SELECT id FROM permissions WHERE name = ${perm.name}
      `;
      
      if (permission.length > 0) {
        const permissionId = permission[0].id;
        
        // Check if role already has this permission
        const existing = await client`
          SELECT id FROM role_permissions 
          WHERE role_id = ${adminRoleId} AND permission_id = ${permissionId}
        `;
        
        if (existing.length === 0) {
          await client`
            INSERT INTO role_permissions (role_id, permission_id)
            VALUES (${adminRoleId}, ${permissionId})
          `;
          console.log(`‚úÖ Assigned ${perm.name} to admin role`);
        } else {
          console.log(`‚ÑπÔ∏è  Admin already has permission: ${perm.name}`);
        }
      }
    }
    
    // Verify admin permissions
    const adminPermissions = await client`
      SELECT p.name, p.category, p.description
      FROM permissions p
      JOIN role_permissions rp ON p.id = rp.permission_id
      JOIN roles r ON rp.role_id = r.id
      WHERE r.name = 'admin' AND p.name LIKE '%vulnerability%'
    `;
    
    console.log('\nüìã Admin vulnerability permissions:');
    console.table(adminPermissions);
    
    console.log('\n‚úÖ Vulnerability permissions setup complete!');
    
  } catch (error) {
    console.error('‚ùå Error setting up permissions:', error.message);
  } finally {
    await client.end();
  }
}

setupVulnerabilityPermissions();
