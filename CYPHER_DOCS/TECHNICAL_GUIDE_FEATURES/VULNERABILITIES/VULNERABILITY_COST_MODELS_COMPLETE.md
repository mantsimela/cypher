# Vulnerability Cost Management Models Implementation

## Overview
Complete Sequelize model implementation for the vulnerability cost management schema based on `shared/vulnerability-cost-schema.ts`. These models provide comprehensive cost analysis, tracking, and calculation capabilities for vulnerability management operations.

## Models Created

### VulnerabilityCostFactor
- **Purpose**: Define cost calculation factors and weights for vulnerability analysis
- **Key Fields**: name, description, weight, category, minValue, maxValue, defaultValue, isActive
- **Features**: Decimal precision (5,2) for weight values, active/inactive status tracking
- **Indexes**: Category, active status, name for efficient factor lookup

### CostCalculationModel (renamed from VulnerabilityCostModel)
- **Purpose**: Store cost calculation formulas and models for vulnerability analysis
- **Key Fields**: name (unique), description, formula, parameters (JSONB), isDefault
- **Features**: JSON parameter storage, default model designation
- **Associations**: Has many VulnerabilityCostAnalysis and VulnerabilityCostHistory records

### VulnerabilityCostAnalysis
- **Purpose**: Store comprehensive cost analysis results for vulnerabilities
- **Key Fields**: vulnerabilityId, costModelId, directCosts, indirectCosts, remediationCosts, timeCosts, totalCost
- **Advanced Fields**: costBenefitRatio, roiPercentage, dataFactors (JSONB), aiConfidence
- **Features**: High precision decimal fields (up to 14,2), AI confidence scoring
- **Associations**: Belongs to Vulnerability and CostCalculationModel

### VulnerabilityCostHistory
- **Purpose**: Track changes in vulnerability cost calculations over time
- **Key Fields**: vulnerabilityId, previousTotalCost, newTotalCost, costModelId, changeReason, changedBy
- **Features**: Audit trail for cost modifications, user tracking for changes
- **Associations**: Belongs to Vulnerability, CostCalculationModel, and User (changedBy)

### RemediationCostEntry
- **Purpose**: Track actual remediation costs for vulnerabilities and POAMs
- **Key Fields**: vulnerabilityId, poamId, costType, amount, currency, description, dateIncurred, recordedBy
- **Features**: Multi-currency support (default USD), flexible cost type categorization
- **Associations**: Belongs to Vulnerability, Poam, and User (recordedBy)

## Database Schema Features

### Cost Calculation Architecture
- **Precision Management**: Decimal fields with appropriate precision for financial calculations
- **Multi-Currency Support**: Currency field with USD default for international operations
- **Flexible Modeling**: JSONB parameters for custom calculation models
- **Audit Capabilities**: Complete change tracking with user attribution

### Performance Optimization
- **Strategic Indexing**: Cost amounts, calculation dates, model IDs, user references
- **Foreign Key Constraints**: Referential integrity across vulnerability and user tables
- **Efficient Queries**: Optimized for cost analysis reporting and trend analysis
- **JSON Indexing**: JSONB fields for complex parameter and factor storage

### Association Architecture
```
CostCalculationModel (1) → VulnerabilityCostAnalysis (many)
CostCalculationModel (1) → VulnerabilityCostHistory (many)
Vulnerability (1) → VulnerabilityCostAnalysis (many)
Vulnerability (1) → VulnerabilityCostHistory (many)
Vulnerability (1) → RemediationCostEntry (many)
Poam (1) → RemediationCostEntry (many)
User (1) → VulnerabilityCostHistory (many) [changedBy]
User (1) → RemediationCostEntry (many) [recordedBy]
```

## Cost Management Capabilities

### Cost Calculation Framework
1. **Factor Definition**: VulnerabilityCostFactor defines weighted calculation components
2. **Model Configuration**: CostCalculationModel stores calculation formulas and parameters
3. **Analysis Storage**: VulnerabilityCostAnalysis records comprehensive cost breakdowns
4. **Change Tracking**: VulnerabilityCostHistory maintains audit trail of cost modifications
5. **Actual Cost Recording**: RemediationCostEntry tracks real expenditures

### Financial Analysis Features
- **Multi-Dimensional Costing**: Direct, indirect, remediation, and time-based costs
- **ROI Calculations**: Cost-benefit ratio and ROI percentage tracking
- **AI Integration**: AI confidence scoring for automated cost estimates
- **Currency Management**: Multi-currency support for global operations
- **Audit Trail**: Complete change history with user attribution

### Reporting and Analytics
- **Cost Trending**: Historical cost analysis and trend identification
- **Budget Planning**: Predictive cost modeling and budget allocation
- **ROI Analysis**: Return on investment calculations for remediation efforts
- **Variance Analysis**: Comparison between estimated and actual costs
- **Custom Modeling**: Flexible formula-based cost calculation models

## Integration Points

### Vulnerability Management Integration
- **Risk Assessment**: Cost factors integrated with vulnerability severity
- **Prioritization**: Cost-benefit analysis for remediation prioritization
- **Resource Planning**: Budget allocation based on cost projections
- **Performance Metrics**: Cost efficiency tracking for remediation programs

### POAM Integration
- **Budget Tracking**: Actual cost recording against planned remediation
- **Milestone Costing**: Cost tracking across POAM lifecycle phases
- **Resource Allocation**: Cost-based resource assignment and planning
- **Completion Analysis**: Final cost analysis and variance reporting

### User Management Integration
- **Responsibility Tracking**: User attribution for cost changes and entries
- **Authorization Controls**: Role-based access to cost modification capabilities
- **Audit Compliance**: Complete user activity tracking for financial audits
- **Workflow Integration**: Cost approval workflows with user assignments

## Technical Implementation

### Data Precision and Accuracy
- **Financial Precision**: Decimal(12,2) for standard amounts, Decimal(14,2) for totals
- **Ratio Calculations**: Decimal(8,4) for precise cost-benefit ratios
- **Percentage Values**: Decimal(8,2) for ROI and confidence percentages
- **Weight Factors**: Decimal(5,2) for calculation factor weights

### Performance Considerations
- **Indexed Queries**: Optimized for cost range filtering and date-based analysis
- **Bulk Operations**: Efficient batch processing for large cost datasets
- **Aggregation Support**: Optimized for sum, average, and trend calculations
- **Join Performance**: Foreign key indexing for complex multi-table queries

### Error Handling and Validation
- **Currency Validation**: Standardized currency code validation
- **Amount Constraints**: Positive value constraints for cost amounts
- **Date Consistency**: Chronological validation for cost history entries
- **Reference Integrity**: Foreign key constraints across all relationships

## Usage Examples

### Cost Analysis Workflow
```typescript
// Create cost analysis for vulnerability
const analysis = await VulnerabilityCostAnalysis.create({
  vulnerabilityId: vulnId,
  costModelId: defaultModel.id,
  directCosts: 5000.00,
  indirectCosts: 2500.00,
  remediationCosts: 7500.00,
  totalCost: 15000.00,
  costBenefitRatio: 3.5,
  calculatedBy: 'AI_SYSTEM'
});

// Track cost changes
const historyEntry = await VulnerabilityCostHistory.create({
  vulnerabilityId: vulnId,
  previousTotalCost: 12000.00,
  newTotalCost: 15000.00,
  changeReason: 'Updated calculation model',
  changedBy: userId
});

// Record actual remediation costs
const costEntry = await RemediationCostEntry.create({
  vulnerabilityId: vulnId,
  costType: 'labor',
  amount: 4500.00,
  currency: 'USD',
  description: 'Security analyst time',
  recordedBy: userId
});
```

### Cost Model Configuration
```typescript
// Define cost calculation factors
const timeFactor = await VulnerabilityCostFactor.create({
  name: 'Time Impact',
  description: 'Hourly cost impact for vulnerability remediation',
  weight: 1.5,
  category: 'time_based',
  minValue: 0.0,
  maxValue: 10.0,
  defaultValue: 2.0
});

// Create calculation model
const costModel = await CostCalculationModel.create({
  name: 'Standard Enterprise Model',
  description: 'Standard cost calculation for enterprise vulnerabilities',
  formula: '(direct + indirect) * severity_weight + remediation_time * hourly_rate',
  parameters: {
    hourly_rate: 150,
    severity_multipliers: { high: 2.0, medium: 1.5, low: 1.0 }
  },
  isDefault: true
});
```

This comprehensive cost management implementation provides enterprise-grade financial tracking and analysis capabilities for vulnerability management operations, supporting budget planning, ROI analysis, and cost-based decision making across the entire vulnerability lifecycle.