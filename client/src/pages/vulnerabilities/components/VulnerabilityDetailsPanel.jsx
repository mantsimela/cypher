import React, { useState } from "react";
import { Badge, Nav, NavItem, NavLink, TabContent, TabPane, Button } from "reactstrap";
import { Icon } from "../../../components/Component";

const VulnerabilityDetailsPanel = ({ isOpen, onClose, vulnerability }) => {
  const [activeTab, setActiveTab] = useState("details");

  const toggleTab = (tab) => {
    if (activeTab !== tab) setActiveTab(tab);
  };

  // Get severity badge color
  const getSeverityBadgeColor = (severity) => {
    switch (severity?.toLowerCase()) {
      case 'critical':
        return 'danger';
      case 'high':
        return 'warning';
      case 'medium':
        return 'info';
      case 'low':
        return 'success';
      default:
        return 'secondary';
    }
  };

  // Get status badge color
  const getStatusBadgeColor = (status) => {
    switch (status?.toLowerCase()) {
      case 'open':
        return 'danger';
      case 'fixed':
        return 'success';
      case 'false_positive':
        return 'warning';
      case 'reopened':
        return 'info';
      case 'new':
        return 'primary';
      default:
        return 'secondary';
    }
  };

  if (!vulnerability) return null;

  return (
    <>
      {/* Backdrop */}
      <div 
        className={`modal-backdrop ${isOpen ? 'show' : ''}`} 
        style={{ 
          display: isOpen ? 'block' : 'none',
          backgroundColor: 'rgba(0,0,0,0.5)',
          zIndex: 1040
        }}
        onClick={onClose}
      />

      {/* Slide-out Panel */}
      <div 
        className={`vulnerability-details-panel ${isOpen ? 'show' : ''}`}
        style={{
          position: 'fixed',
          top: 0,
          right: 0,
          height: '100vh',
          width: '1000px',
          maxWidth: '95vw',
          backgroundColor: 'white',
          boxShadow: '-2px 0 10px rgba(0,0,0,0.1)',
          zIndex: 1050,
          transform: isOpen ? 'translateX(0)' : 'translateX(100%)',
          transition: 'transform 0.3s ease-in-out',
          overflowY: 'auto',
          overflowX: 'hidden'
        }}
      >
        {/* Header */}
        <div className="card-inner border-bottom" style={{ padding: '1.5rem' }}>
          <div className="d-flex justify-content-between align-items-start">
            <div className="flex-grow-1">
              <h5 className="mb-2">
                Vulnerability #{vulnerability.plugin_id}: {vulnerability.plugin_name}
              </h5>
              <div className="text-muted small mb-2">
                {vulnerability.cves && vulnerability.cves.length > 0 ? 
                  vulnerability.cves[0].cve_id : 'No CVE assigned'
                }
              </div>
              <div className="d-flex gap-2 align-items-center">
                <Badge color={getSeverityBadgeColor(vulnerability.severity_name)}>
                  {vulnerability.severity_name} Severity
                </Badge>
                <span className="text-muted">CVSS: {vulnerability.cvss3_base_score || 'N/A'}</span>
              </div>
            </div>
            <Button 
              color="light" 
              size="sm" 
              className="btn-icon"
              onClick={onClose}
            >
              <Icon name="cross" />
            </Button>
          </div>
        </div>

        {/* Description */}
        <div className="card-inner border-bottom" style={{ padding: '1rem 1.5rem' }}>
          <p className="text-muted mb-0" style={{ fontSize: '0.9rem', lineHeight: '1.5' }}>
            {vulnerability.description || 'A critical vulnerability in MySQL allows attackers to potentially cause devastating impact through SQL injection in the authentication module. This could lead to unauthorized access, data leakage, or service disruption. A security patch is available to address this issue.'}
          </p>
        </div>

        {/* Tabs Navigation */}
        <div className="card-inner border-bottom" style={{ padding: '0 1.5rem' }}>
          <Nav tabs className="nav-tabs-mb0">
            <NavItem>
              <NavLink
                className={activeTab === "details" ? "active" : ""}
                onClick={() => toggleTab("details")}
                style={{ cursor: 'pointer' }}
              >
                Details
              </NavLink>
            </NavItem>
            <NavItem>
              <NavLink
                className={activeTab === "affected" ? "active" : ""}
                onClick={() => toggleTab("affected")}
                style={{ cursor: 'pointer' }}
              >
                Affected
              </NavLink>
            </NavItem>
            <NavItem>
              <NavLink
                className={activeTab === "remediation" ? "active" : ""}
                onClick={() => toggleTab("remediation")}
                style={{ cursor: 'pointer' }}
              >
                Remediation
              </NavLink>
            </NavItem>
            <NavItem>
              <NavLink
                className={activeTab === "cost_analysis" ? "active" : ""}
                onClick={() => toggleTab("cost_analysis")}
                style={{ cursor: 'pointer' }}
              >
                Cost Analysis
              </NavLink>
            </NavItem>
            <NavItem>
              <NavLink
                className={activeTab === "references" ? "active" : ""}
                onClick={() => toggleTab("references")}
                style={{ cursor: 'pointer' }}
              >
                References
              </NavLink>
            </NavItem>
          </Nav>
        </div>

        {/* Tab Content */}
        <div className="card-inner" style={{ padding: '1.5rem', minHeight: '400px' }}>
          <TabContent activeTab={activeTab}>
            {/* Details Tab */}
            <TabPane tabId="details">
              <div className="vulnerability-details">
                <div className="row g-3">
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Vector String</label>
                      <div className="form-control-plaintext">
                        <code className="text-primary">CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H</code>
                      </div>
                      {/* Vector String Progress Bar */}
                      <div className="progress mt-2" style={{ height: '6px' }}>
                        <div 
                          className="progress-bar bg-secondary" 
                          style={{ width: '45%' }}
                        ></div>
                        <div 
                          className="progress-bar bg-primary" 
                          style={{ width: '35%' }}
                        ></div>
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Category</label>
                      <div className="form-control-plaintext">
                        <Badge color="light">Database</Badge>
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Type</label>
                      <div className="form-control-plaintext">SQL Injection</div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">CWE</label>
                      <div className="form-control-plaintext">CWE-2020-8181</div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Exploitability</label>
                      <div className="d-flex align-items-center">
                        <div className="progress flex-grow-1 me-2" style={{ height: '8px' }}>
                          <div className="progress-bar bg-warning" style={{ width: '60%' }}></div>
                        </div>
                        <span className="text-muted small">6.0</span>
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Impact</label>
                      <div className="d-flex align-items-center">
                        <div className="progress flex-grow-1 me-2" style={{ height: '8px' }}>
                          <div className="progress-bar bg-danger" style={{ width: '100%' }}></div>
                        </div>
                        <span className="text-muted small">10.0</span>
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Disclosure Date</label>
                      <div className="form-control-plaintext">
                        <Icon name="calendar" className="me-1" />
                        Unknown
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Exploit Status</label>
                      <div className="form-control-plaintext">
                        <Badge color="warning">Unconfirmed</Badge>
                      </div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Attack Vector</label>
                      <div className="form-control-plaintext">Network</div>
                    </div>
                  </div>
                  <div className="col-6">
                    <div className="form-group">
                      <label className="form-label text-muted">Attack Complexity</label>
                      <div className="form-control-plaintext">High</div>
                    </div>
                  </div>
                </div>
              </div>
            </TabPane>

            {/* Affected Tab */}
            <TabPane tabId="affected">
              <div className="affected-content">
                <div className="alert alert-light mb-4">
                  <h6 className="alert-heading">Affected Systems</h6>
                  <p className="mb-0">This vulnerability affects the following systems and components:</p>
                </div>
                
                <div className="card border">
                  <div className="card-body">
                    <h6>Asset Information</h6>
                    <div className="row g-3">
                      <div className="col-md-6">
                        <strong>Asset UUID:</strong><br/>
                        <code className="text-muted">{vulnerability.asset_uuid || 'Not available'}</code>
                      </div>
                      <div className="col-md-6">
                        <strong>Plugin Family:</strong><br/>
                        {vulnerability.plugin_family || 'Not specified'}
                      </div>
                    </div>
                  </div>
                </div>

                <div className="mt-4">
                  <h6>Additional Affected Information</h6>
                  <p className="text-muted">Detailed affected systems analysis will be populated here based on scan results and asset inventory data.</p>
                </div>
              </div>
            </TabPane>

            {/* Remediation Tab */}
            <TabPane tabId="remediation">
              <div className="remediation-content">
                {/* Patch Available */}
                <div className="mb-4">
                  <div className="d-flex align-items-center">
                    <h6 className="mb-0 me-3">Patch Available</h6>
                    <Badge color="danger">No</Badge>
                  </div>
                </div>

                {/* Workaround */}
                <div className="mb-4">
                  <h6>Workaround</h6>
                  <p className="text-muted">
                    Until a patch is available, a temporary workaround can be implemented by disabling the affected
                    feature in Microsoft Edge.
                  </p>
                </div>

                {/* Mitigation Steps */}
                <div className="mb-4">
                  <h6>Mitigation Steps</h6>
                  <ul className="ps-3">
                    <li className="mb-2">Update to the latest version of the software</li>
                    <li className="mb-2">Apply vendor-provided security patches</li>
                  </ul>
                </div>

                {/* Recommended Actions */}
                <div className="mb-4">
                  <h6>Recommended Actions</h6>
                  <ul className="ps-3">
                    <li className="mb-2">Prioritize patching based on system criticality</li>
                    <li className="mb-2">Perform system scanning to verify remediation</li>
                  </ul>
                </div>

                <hr className="my-4" />

                {/* AI-Powered Remediation Suggestions */}
                <div className="mb-4">
                  <div className="d-flex justify-content-between align-items-center mb-3">
                    <h6 className="mb-0">AI-Powered Remediation Suggestions</h6>
                    <Button color="primary">
                      Generate Suggestions
                    </Button>
                  </div>
                  
                  <div className="card border" style={{ backgroundColor: '#f8f9fa' }}>
                    <div className="card-body py-4">
                      <p className="text-muted text-center mb-0">
                        Click the "Generate Suggestions" button to get AI-powered remediation
                        recommendations for this vulnerability.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </TabPane>

            {/* Cost Analysis Tab */}
            <TabPane tabId="cost_analysis">
              <div className="cost-analysis-content">
                <div className="alert alert-warning mb-4">
                  <h6 className="alert-heading">Cost Impact Analysis</h6>
                  <p className="mb-0">Estimated cost and business impact of this vulnerability:</p>
                </div>

                <div className="row g-3">
                  <div className="col-md-6">
                    <div className="card border">
                      <div className="card-body text-center">
                        <h5 className="text-primary">$2,500</h5>
                        <p className="text-muted mb-0">Estimated Remediation Cost</p>
                      </div>
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="card border">
                      <div className="card-body text-center">
                        <h5 className="text-danger">$25,000</h5>
                        <p className="text-muted mb-0">Potential Loss if Exploited</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="mt-4">
                  <h6>Cost Breakdown</h6>
                  <div className="table-responsive">
                    <table className="table table-sm">
                      <thead>
                        <tr>
                          <th>Component</th>
                          <th>Estimated Hours</th>
                          <th>Cost</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>Analysis & Planning</td>
                          <td>8 hours</td>
                          <td>$800</td>
                        </tr>
                        <tr>
                          <td>Patch Development</td>
                          <td>12 hours</td>
                          <td>$1,200</td>
                        </tr>
                        <tr>
                          <td>Testing & Validation</td>
                          <td>5 hours</td>
                          <td>$500</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </TabPane>

            {/* References Tab */}
            <TabPane tabId="references">
              <div className="references-content">
                <div className="alert alert-light mb-4">
                  <h6 className="alert-heading">External References</h6>
                  <p className="mb-0">Additional resources and references for this vulnerability:</p>
                </div>

                {/* CVE References */}
                {vulnerability.cves && vulnerability.cves.length > 0 && (
                  <div className="mb-4">
                    <h6>CVE References</h6>
                    {vulnerability.cves.map((cve, index) => (
                      <div key={index} className="card border mb-2">
                        <div className="card-body py-2">
                          <div className="d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{cve.cve_id}</strong>
                              {cve.cvss3_base_score && (
                                <Badge color="info" className="ms-2">
                                  CVSS: {cve.cvss3_base_score}
                                </Badge>
                              )}
                            </div>
                            <a 
                              href={`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve.cve_id}`}
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="btn btn-sm btn-outline-primary"
                            >
                              <Icon name="external" className="me-1" />
                              View CVE
                            </a>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Additional References */}
                <div>
                  <h6>Additional Resources</h6>
                  <div className="list-group">
                    <a href="#" className="list-group-item list-group-item-action">
                      <div className="d-flex w-100 justify-content-between">
                        <h6 className="mb-1">MySQL Security Documentation</h6>
                        <small><Icon name="external" /></small>
                      </div>
                      <p className="mb-1 text-muted">Official MySQL security best practices and guidelines</p>
                    </a>
                    <a href="#" className="list-group-item list-group-item-action">
                      <div className="d-flex w-100 justify-content-between">
                        <h6 className="mb-1">OWASP SQL Injection Prevention</h6>
                        <small><Icon name="external" /></small>
                      </div>
                      <p className="mb-1 text-muted">Comprehensive guide on preventing SQL injection attacks</p>
                    </a>
                    <a href="#" className="list-group-item list-group-item-action">
                      <div className="d-flex w-100 justify-content-between">
                        <h6 className="mb-1">NIST Vulnerability Database</h6>
                        <small><Icon name="external" /></small>
                      </div>
                      <p className="mb-1 text-muted">National Vulnerability Database entry for this vulnerability</p>
                    </a>
                  </div>
                </div>
              </div>
            </TabPane>
          </TabContent>
        </div>

        {/* Footer Actions */}
        <div className="card-inner border-top mt-auto" style={{ padding: '1rem 1.5rem' }}>
          <div className="d-flex justify-content-between">
            <Button color="light" onClick={onClose}>
              Close
            </Button>
            <div className="d-flex gap-2">
              <Button color="secondary">
                Assign
              </Button>
              <Button color="info">
                Generate POAM
              </Button>
              <Button color="primary">
                Start Remediation
              </Button>
            </div>
          </div>
        </div>
      </div>
    </>
  );
};

export default VulnerabilityDetailsPanel;