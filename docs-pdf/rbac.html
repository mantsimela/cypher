<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rbac</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.css" />
</head>
<body>
<h1 id="rbac-role-based-access-control-implementation">RBAC (Role-Based
Access Control) Implementation</h1>
<p>Comprehensive guide to the Role-Based Access Control system
implemented in the RAS Dashboard API, including permissions, roles,
middleware, and best practices.</p>
<h2 id="overview">üéØ Overview</h2>
<p>The RBAC system provides fine-grained access control through: -
<strong>Permissions</strong> - Specific actions users can perform -
<strong>Roles</strong> - Collections of permissions - <strong>User-Role
Assignments</strong> - Users can have multiple roles -
<strong>Middleware</strong> - Automatic permission checking -
<strong>Caching</strong> - Performance optimization</p>
<h2 id="database-schema">üèóÔ∏è Database Schema</h2>
<h3 id="core-tables">Core Tables</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Permissions: Define what actions can be performed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>permissions (<span class="kw">id</span>, name, description, <span class="kw">category</span>, created_at, updated_at)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Roles: Group permissions together</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">roles</span> (<span class="kw">id</span>, name, description, is_system, is_default, created_at, updated_at)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Role-Permission Assignments: Many-to-many</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>role_permissions (<span class="kw">id</span>, role_id, permission_id)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- User-Role Assignments: Many-to-many</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>user_roles (<span class="kw">id</span>, user_id, role_id, assigned_at, assigned_by, created_at, updated_at)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Users: Extended with role enum for backward compatibility</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>users (<span class="kw">id</span>, username, email, <span class="kw">role</span>, status, <span class="op">..</span>.)</span></code></pre></div>
<h3 id="relationships">Relationships</h3>
<pre><code>Users ‚Üê‚Üí UserRoles ‚Üê‚Üí Roles ‚Üê‚Üí RolePermissions ‚Üê‚Üí Permissions</code></pre>
<h2 id="permission-system">üîê Permission System</h2>
<h3 id="permission-naming-convention">Permission Naming Convention</h3>
<pre><code>&lt;resource&gt;:&lt;action&gt;</code></pre>
<p><strong>Examples:</strong> - <code>users:read</code> - View user
information - <code>users:write</code> - Create and update users -
<code>users:delete</code> - Delete users - <code>admin:dashboard</code>
- Access admin dashboard - <code>reports:read</code> - View reports</p>
<h3 id="default-permissions">Default Permissions</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Users Category</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>users<span class="op">:</span>read<span class="op">,</span> users<span class="op">:</span>write<span class="op">,</span> users<span class="op">:</span><span class="kw">delete</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Roles Category  </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>roles<span class="op">:</span>read<span class="op">,</span> roles<span class="op">:</span>write<span class="op">,</span> roles<span class="op">:</span><span class="kw">delete</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Permissions Category</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>permissions<span class="op">:</span>read<span class="op">,</span> permissions<span class="op">:</span>write</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Admin Category</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>admin<span class="op">:</span>dashboard</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">// System Category</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>system<span class="op">:</span>manage</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Reports Category</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>reports<span class="op">:</span>read<span class="op">,</span> reports<span class="op">:</span>write</span></code></pre></div>
<h3 id="permission-categories">Permission Categories</h3>
<p>Permissions are organized by category for better management: -
<code>users</code> - User management - <code>roles</code> - Role
management - <code>permissions</code> - Permission management -
<code>admin</code> - Administrative functions - <code>system</code> -
System-level operations - <code>reports</code> - Reporting and
analytics</p>
<h2 id="role-system">üë• Role System</h2>
<h3 id="default-roles">Default Roles</h3>
<h4 id="admin-role">Admin Role</h4>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Full system access&#39;</span><span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isSystem</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDefault</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">permissions</span><span class="op">:</span> [<span class="st">&#39;*&#39;</span>] <span class="co">// All permissions</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="user-role">User Role</h4>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Basic user access&#39;</span><span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isSystem</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDefault</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">permissions</span><span class="op">:</span> [<span class="st">&#39;users:read&#39;</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="moderator-role">Moderator Role</h4>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;moderator&#39;</span><span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Moderate content and users&#39;</span><span class="op">,</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isSystem</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDefault</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">permissions</span><span class="op">:</span> [<span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;users:write&#39;</span><span class="op">,</span> <span class="st">&#39;roles:read&#39;</span><span class="op">,</span> <span class="st">&#39;reports:read&#39;</span>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="viewer-role">Viewer Role</h4>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;viewer&#39;</span><span class="op">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Read-only access&#39;</span><span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isSystem</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDefault</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">permissions</span><span class="op">:</span> [<span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;reports:read&#39;</span>]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="role-properties">Role Properties</h3>
<ul>
<li><strong>isSystem</strong> - System roles cannot be deleted</li>
<li><strong>isDefault</strong> - Default role assigned to new users</li>
<li><strong>permissions</strong> - Array of permission names or ‚Äô*‚Äô for
all</li>
</ul>
<h2 id="middleware-implementation">üõ°Ô∏è Middleware Implementation</h2>
<h3 id="basic-permission-check">Basic Permission Check</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { requirePermission } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Require specific permission</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/admin&#39;</span><span class="op">,</span> <span class="fu">requirePermission</span>(<span class="st">&#39;admin:dashboard&#39;</span>)<span class="op">,</span> controller<span class="op">.</span><span class="at">adminDashboard</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="multiple-permission-options">Multiple Permission Options</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { requireAnyPermission } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">// User needs ANY of these permissions</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> <span class="fu">requireAnyPermission</span>([<span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;admin:dashboard&#39;</span>])<span class="op">,</span> controller<span class="op">.</span><span class="at">getUsers</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="all-permissions-required">All Permissions Required</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { requireAllPermissions } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">// User needs ALL of these permissions</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/admin/users&#39;</span><span class="op">,</span> <span class="fu">requireAllPermissions</span>([<span class="st">&#39;users:write&#39;</span><span class="op">,</span> <span class="st">&#39;admin:dashboard&#39;</span>])<span class="op">,</span> controller<span class="op">.</span><span class="at">createUser</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="ownership-or-permission">Ownership or Permission</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { requireOwnershipOrPermission } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">// User can access their own data OR have admin permission</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">put</span>(<span class="st">&#39;/users/:id&#39;</span><span class="op">,</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requireOwnershipOrPermission</span>(<span class="st">&#39;users:write&#39;</span><span class="op">,</span> req <span class="kw">=&gt;</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>))<span class="op">,</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  controller<span class="op">.</span><span class="at">updateUser</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<h2 id="usage-examples">üöÄ Usage Examples</h2>
<h3 id="protecting-routes">Protecting Routes</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { authenticateToken } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/auth&#39;</span>)<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { requirePermission<span class="op">,</span> requireAnyPermission } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> router <span class="op">=</span> express<span class="op">.</span><span class="fu">Router</span>()<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">// All routes require authentication</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">use</span>(authenticateToken)<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Admin only</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/admin/dashboard&#39;</span><span class="op">,</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requirePermission</span>(<span class="st">&#39;admin:dashboard&#39;</span>)<span class="op">,</span> </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  controller<span class="op">.</span><span class="at">adminDashboard</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Users with read permission</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requirePermission</span>(<span class="st">&#39;users:read&#39;</span>)<span class="op">,</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  controller<span class="op">.</span><span class="at">getUsers</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple permission options</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/reports&#39;</span><span class="op">,</span> </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requireAnyPermission</span>([<span class="st">&#39;reports:read&#39;</span><span class="op">,</span> <span class="st">&#39;admin:dashboard&#39;</span>])<span class="op">,</span> </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  controller<span class="op">.</span><span class="at">getReports</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Ownership or admin</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">put</span>(<span class="st">&#39;/users/:id&#39;</span><span class="op">,</span> </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requireOwnershipOrPermission</span>(<span class="st">&#39;users:write&#39;</span><span class="op">,</span> req <span class="kw">=&gt;</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>))<span class="op">,</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  controller<span class="op">.</span><span class="at">updateUser</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<h3 id="checking-permissions-in-controllers">Checking Permissions in
Controllers</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { getUserPermissions } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controller <span class="op">=</span> {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getUsers</span>(req<span class="op">,</span> res) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get user&#39;s permissions</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> permissions <span class="op">=</span> <span class="cf">await</span> <span class="fu">getUserPermissions</span>(req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Conditional logic based on permissions</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (permissions<span class="op">.</span><span class="fu">has</span>(<span class="st">&#39;admin:dashboard&#39;</span>)) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Admin can see all user data</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      users <span class="op">=</span> <span class="cf">await</span> userService<span class="op">.</span><span class="fu">getAllUsers</span>({ <span class="dt">includeInactive</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Regular users see limited data</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      users <span class="op">=</span> <span class="cf">await</span> userService<span class="op">.</span><span class="fu">getAllUsers</span>({ <span class="dt">includeInactive</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({ users })<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="performance-optimization">‚ö° Performance Optimization</h2>
<h3 id="permission-caching">Permission Caching</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Permissions are cached for 5 minutes per user</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CACHE_TTL <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 5 minutes</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Cache is automatically managed</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> permissions <span class="op">=</span> <span class="cf">await</span> <span class="fu">getUserPermissions</span>(userId)<span class="op">;</span> <span class="co">// Cached result</span></span></code></pre></div>
<h3 id="cache-management">Cache Management</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { clearUserPermissionCache<span class="op">,</span> clearAllPermissionCache } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../middleware/rbac&#39;</span>)<span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear cache when user roles change</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">assignRolesToUser</span>(userId<span class="op">,</span> newRoleIds)<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">clearUserPermissionCache</span>(userId)<span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear all cache when permissions/roles change</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">updateRolePermissions</span>(roleId<span class="op">,</span> newPermissionIds)<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">clearAllPermissionCache</span>()<span class="op">;</span></span></code></pre></div>
<h2 id="management-operations">üõ†Ô∏è Management Operations</h2>
<h3 id="role-management">Role Management</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rbacService <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;../services/rbacService&#39;</span>)<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create new role</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> newRole <span class="op">=</span> <span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">createRole</span>({</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;editor&#39;</span><span class="op">,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Content editor&#39;</span><span class="op">,</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isSystem</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDefault</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Assign permissions to role</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">assignPermissionsToRole</span>(newRole<span class="op">.</span><span class="at">id</span><span class="op">,</span> [</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  permissionIds<span class="op">.</span><span class="fu">find</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">&#39;users:read&#39;</span>)<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  permissionIds<span class="op">.</span><span class="fu">find</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">&#39;reports:write&#39;</span>)<span class="op">.</span><span class="at">id</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span></code></pre></div>
<h3 id="user-role-assignment">User Role Assignment</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Assign roles to user</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">assignRolesToUser</span>(userId<span class="op">,</span> [adminRoleId<span class="op">,</span> moderatorRoleId])<span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Get user&#39;s roles</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userRoles <span class="op">=</span> <span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">getUserRoles</span>(userId)<span class="op">;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Remove specific role from user</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">removeRoleFromUser</span>(userId<span class="op">,</span> roleId)<span class="op">;</span></span></code></pre></div>
<h3 id="permission-management">Permission Management</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create new permission</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> newPermission <span class="op">=</span> <span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">createPermission</span>({</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;analytics:read&#39;</span><span class="op">,</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">category</span><span class="op">:</span> <span class="st">&#39;analytics&#39;</span><span class="op">,</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;View analytics data&#39;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Get role permissions</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rolePermissions <span class="op">=</span> <span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">getRolePermissions</span>(roleId)<span class="op">;</span></span></code></pre></div>
<h2 id="querying-rbac-data">üîç Querying RBAC Data</h2>
<h3 id="check-user-permissions">Check User Permissions</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See user-role assignments</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run db:query user-roles</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># See role-permission assignments  </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run db:query role-permissions</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># See all permissions by category</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run db:query permissions:by-category</span></code></pre></div>
<h3 id="database-queries">Database Queries</h3>
<div class="sourceCode" id="cb21"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Get all permissions for a user</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> p.name, p.<span class="kw">category</span>, p.description</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> users u</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> user_roles ur <span class="kw">ON</span> u.<span class="kw">id</span> <span class="op">=</span> ur.user_id</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> <span class="kw">roles</span> r <span class="kw">ON</span> ur.role_id <span class="op">=</span> r.<span class="kw">id</span>  </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> role_permissions rp <span class="kw">ON</span> r.<span class="kw">id</span> <span class="op">=</span> rp.role_id</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> permissions p <span class="kw">ON</span> rp.permission_id <span class="op">=</span> p.<span class="kw">id</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> u.<span class="kw">id</span> <span class="op">=</span> $<span class="dv">1</span>;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Get users with specific permission</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> u.username, u.email</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> users u</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> user_roles ur <span class="kw">ON</span> u.<span class="kw">id</span> <span class="op">=</span> ur.user_id</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> <span class="kw">roles</span> r <span class="kw">ON</span> ur.role_id <span class="op">=</span> r.<span class="kw">id</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> role_permissions rp <span class="kw">ON</span> r.<span class="kw">id</span> <span class="op">=</span> rp.role_id  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> permissions p <span class="kw">ON</span> rp.permission_id <span class="op">=</span> p.<span class="kw">id</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p.name <span class="op">=</span> <span class="st">&#39;admin:dashboard&#39;</span>;</span></code></pre></div>
<h2 id="best-practices">üéØ Best Practices</h2>
<h3 id="principle-of-least-privilege">1. Principle of Least
Privilege</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Give users minimum permissions needed</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> basicUserPermissions <span class="op">=</span> [<span class="st">&#39;users:read&#39;</span>]<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> moderatorPermissions <span class="op">=</span> [<span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;users:write&#39;</span><span class="op">,</span> <span class="st">&#39;reports:read&#39;</span>]<span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> adminPermissions <span class="op">=</span> [<span class="st">&#39;*&#39;</span>]<span class="op">;</span> <span class="co">// All permissions</span></span></code></pre></div>
<h3 id="use-descriptive-permission-names">2. Use Descriptive Permission
Names</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;reports:export&#39;</span><span class="op">,</span> <span class="st">&#39;admin:dashboard&#39;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Avoid</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="st">&#39;write&#39;</span><span class="op">,</span> <span class="st">&#39;admin&#39;</span></span></code></pre></div>
<h3 id="organize-by-categories">3. Organize by Categories</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Group related permissions</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userPermissions <span class="op">=</span> [<span class="st">&#39;users:read&#39;</span><span class="op">,</span> <span class="st">&#39;users:write&#39;</span><span class="op">,</span> <span class="st">&#39;users:delete&#39;</span>]<span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> reportPermissions <span class="op">=</span> [<span class="st">&#39;reports:read&#39;</span><span class="op">,</span> <span class="st">&#39;reports:write&#39;</span><span class="op">,</span> <span class="st">&#39;reports:export&#39;</span>]<span class="op">;</span></span></code></pre></div>
<h3 id="handle-permission-changes-gracefully">4. Handle Permission
Changes Gracefully</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Always clear cache when permissions change</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">updateUserRoles</span>(userId<span class="op">,</span> newRoles)<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clearUserPermissionCache</span>(userId)<span class="op">;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Check permissions exist before using</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (permissions<span class="op">.</span><span class="fu">has</span>(<span class="st">&#39;new:feature&#39;</span>)) {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Feature is available</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="audit-permission-usage">5. Audit Permission Usage</h3>
<div class="sourceCode" id="cb26"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Log permission checks for security auditing</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hasPermission <span class="op">=</span> permissions<span class="op">.</span><span class="fu">has</span>(<span class="st">&#39;sensitive:operation&#39;</span>)<span class="op">;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (hasPermission) {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  logger<span class="op">.</span><span class="fu">info</span>(<span class="vs">`User </span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs"> accessed sensitive operation`</span>)<span class="op">;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="troubleshooting">üîß Troubleshooting</h2>
<h3 id="permission-denied-issues">Permission Denied Issues</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Debug user permissions</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> permissions <span class="op">=</span> <span class="cf">await</span> <span class="fu">getUserPermissions</span>(userId)<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User permissions:&#39;</span><span class="op">,</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(permissions))<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Check role assignments</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> roles <span class="op">=</span> <span class="cf">await</span> rbacService<span class="op">.</span><span class="fu">getUserRoles</span>(userId)<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User roles:&#39;</span><span class="op">,</span> roles)<span class="op">;</span></span></code></pre></div>
<h3 id="cache-issues">Cache Issues</h3>
<div class="sourceCode" id="cb28"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear cache if permissions seem stale</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clearUserPermissionCache</span>(userId)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">// or</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">clearAllPermissionCache</span>()<span class="op">;</span></span></code></pre></div>
<h3 id="performance-issues">Performance Issues</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Check cache hit rates</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Consider increasing cache TTL for stable permissions</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Use database indexes on foreign keys</span></span></code></pre></div>
<h2 id="advanced-features">üöÄ Advanced Features</h2>
<h3 id="dynamic-permissions">Dynamic Permissions</h3>
<div class="sourceCode" id="cb30"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Generate permissions based on context</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dynamicPermission <span class="op">=</span> <span class="vs">`project:</span><span class="sc">${</span>projectId<span class="sc">}</span><span class="vs">:read`</span><span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (permissions<span class="op">.</span><span class="fu">has</span>(dynamicPermission)) {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// User can read this specific project</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="hierarchical-roles">Hierarchical Roles</h3>
<div class="sourceCode" id="cb31"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Implement role inheritance</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> roleHierarchy <span class="op">=</span> {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;admin&#39;</span><span class="op">:</span> [<span class="st">&#39;moderator&#39;</span><span class="op">,</span> <span class="st">&#39;user&#39;</span>]<span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;moderator&#39;</span><span class="op">:</span> [<span class="st">&#39;user&#39;</span>]<span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;user&#39;</span><span class="op">:</span> []</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="conditional-permissions">Conditional Permissions</h3>
<div class="sourceCode" id="cb32"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Time-based or context-based permissions</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> isBusinessHours <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">getHours</span>() <span class="op">&gt;=</span> <span class="dv">9</span> <span class="op">&amp;&amp;</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">getHours</span>() <span class="op">&lt;=</span> <span class="dv">17</span><span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (permissions<span class="op">.</span><span class="fu">has</span>(<span class="st">&#39;admin:dashboard&#39;</span>) <span class="op">&amp;&amp;</span> isBusinessHours) {</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Admin access during business hours only</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This RBAC system provides a robust, scalable foundation for managing
access control in your application while maintaining performance and
security.</p>
</body>
</html>
